var hdnIsFreeUser = false;
var finalval = 10;

$(document).ready(function () {
    var hdnIsFreeUser = $("#IsFreeUser").val();
    $('#AdditionalPets').val("0");

    $("#AdditionalPetRenewal option").filter(function (index) { return $(this).val() === '0'; }).html($('#changeselectText').val()).val(0);
    var selectedItem = parseInt($('#CurrentPlan_NumberofPets').val());
    $('#AdditionalPetRenewal').val(selectedItem);
    GetPlanDetails(hdnIsFreeUser);

    $('#CancelRenewalPlan').click(function () {
        $('#RenewaltMyPlan').removeClass('tab-pane fade in active').addClass('tab-pane fade');
        $('#MyPlan').removeClass('tab-pane fade').addClass('tab-pane fade in active');
        localStorage.clear();

        $.getJSON(GetApplicationPath() + "Profile/ClearSessionData",
            function (data) {
               // console.log(data);
            });

        $("#dvDeletedItem").val('');
        $("#DeletedUnUsedPets").val('');
        $('#CurrentPlan_NumberofPets').val($('#PlanDetails_numberofPets').val());
        $('#AdditionalPetRenewal').val($('#PlanDetails_numberofPets').val());
      //  getRenwalPetsPrice();
    });


    $("#PlanName").change(function () {
        GetPlanDetails(hdnIsFreeUser);
    });

    $("#AdditionalPetRenewal").change(function () {
        getRenwalPetsPrice();

    });

    $('#PlansByPromoCode').click(function () {
        ChangePlanListByPromoCode();
    });


    $('#RemovePets').click(function (e) {
        e.preventDefault();
        $.get(this.href, function (data) {
            $('#DeletepetsModel').html(data);
            Initialize();
            //$.validator.unobtrusive.parse("#addPulseForm");
            $('#DeletepetsModel').modal('show');
        });
    });
});

function getRenwalPetsPrice() {
    var Planid = $('#PlanName :selected').val();
    var AdditionalPets = $('#AdditionalPetRenewal :selected').val();
    AdditionalPets = AdditionalPets || 0;
    var selectedItem = parseInt($('#CurrentPlan_NumberofPets').val());
    selectedItem = selectedItem || 0;
    if (AdditionalPets < selectedItem) {
        if (Planid != '1') {
            $("#AdditionalPetRenewal").addClass("input-validation-error");
            $("#AddPetsRenewalErrMsg").show();
            GetPrice(selectedItem);
        } else {
            GetPrice(AdditionalPets);
        }
        //$("#AdditionalPetRenewal").addClass("input-validation-error");
        //$("#AddPetsRenewalErrMsg").show();
        //GetPrice(selectedItem);
    } else {
        $("#AddPetsRenewalErrMsg").hide();
        $("#AdditionalPetRenewal").removeClass("input-validation-error");
        GetPrice(AdditionalPets);
    }
}

function GetPrice(AdditionalPets) {
    var Planid = $('#PlanName :selected').val();
    $.getJSON(GetApplicationPath() + "Profile/GetPlanPrice", { PlanID: Planid, AdditionalPets: AdditionalPets },
    function (data) {
        $('#RenuewalPlan').text(data.finalPlan);
        $('#RenewalPrice').text($("meta[name='accept-currency']").attr("content") + data.price);
        $("#AdditionalInfo").text(data.AdditionalInfo);
    });
}

function GetPlanDetails(hdnIsFreeUser) {
    var renewalDate;
    var culture = GetCurrentCulture();
    var Planid = $('#PlanName :selected').val();
    var remainingDays = parseInt($('#RemainingDays').val(), 10);
    if (remainingDays > 0) {
        var d = new Date($('#CurrentPlan_EndDate').val());

        if (culture == "en-US") {
            renewalDate = (d.getMonth() + 1) + "/" + (d.getDate() + 1) + "/" + d.getFullYear();
        } else {
            renewalDate = (d.getDate() + 1) + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
        }

        if (hdnIsFreeUser) {
            d = new Date($('#lblStartDate').text());

            if (culture == "en-US") {
                renewalDate = (d.getMonth() + 1) + "/" + (d.getDate()) + "/" + d.getFullYear();
            } else {
                renewalDate = (d.getDate()) + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
            }
        }

    } else {
        var d = new Date()
        if (culture == "en-US") {
            renewalDate = (d.getMonth() + 1) + "/" + (d.getDate()) + "/" + d.getFullYear();
        } else {
            renewalDate = d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
        }
    }

    if (Planid == '1') {
        $("#AdditionalPetRenewal").removeAttr('readonly');
        $("#AdditionalPetRenewal").removeAttr('disabled');
        //CalculatePrice(false);
    } else if (Planid == '2') {
        $("#AdditionalPetRenewal").attr('readonly', 'readonly');
        $("#AdditionalPetRenewal").attr('disabled', 'disabled');
    } else {
        // $70 plan
        $("#AdditionalPetRenewal").attr('readonly', 'readonly');
        $("#AdditionalPetRenewal").attr('disabled', 'disabled');
    }

    $.getJSON(GetApplicationPath() + "Profile/GetStartDate", { PlanID: Planid, RenewalDate: renewalDate },
    function (data) {
        var expDate;
        var startdate;

        // get expdate
        var dateString = data.ExpirationDate.substr(6);
        var d = new Date(parseInt(dateString));
        if (culture == "en-US") {
            expDate = (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
        } else {
            expDate = d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
        }

        //get startDate
        var dateString2 = data.StartDate.substr(6);
        var sd = new Date(parseInt(dateString2));
        if (culture == "en-US") {
            startdate = (sd.getMonth() + 1) + "/" + sd.getDate() + "/" + sd.getFullYear();
        } else {
            startdate = sd.getDate() + "/" + (sd.getMonth() + 1) + "/" + sd.getFullYear();
        }
        $("#AdditionalInfo").text(data.additionalInfo);
        $('#lblStartDate').text(startdate);
        $('#StartDate').val(startdate);
        $('#lblExpirationDate').text(expDate);
        $('#EndDate').val(expDate);
        $('#Duration').text(data.Dueration);
        $('#TotalRemainigDays').text(data.RemainingDyas);
        $('#RenewalPrice').text(data.price);
        $('#RenuewalPlan').text(data.planinfo);
        $("#MaxPetCount").val(data.MaxPetCount);
        if (Planid == '1') {
            CalculatePrice(false);
        }
        else { CalculatePrice(); }
    });
}

function ChangePlanListByPromoCode() {
    var promocode = $('#IdPromo').val();
    var CurrentPromo = $('#Promocode').val();
    var AdditionalPets = $('#AdditionalPetRenewal :selected').val();
    AdditionalPets = AdditionalPets ? AdditionalPets : 0;
    var subItems;
    $.getJSON(GetApplicationPath() + "Profile/GetPlansByPromocode", { promocode: promocode, AdditionalPets: AdditionalPets, CurrentPromo: CurrentPromo },
            function (data) {
                if (data.length == 0) {
                    $("#AdditionalPetRenewal").addClass("input-validation-error");
                    $("#RenewalPromocodeErrMsg").css('opacity', '');
                    $("#RenewalPromocodeErrMsg").show();
                    $("#RenewalPromocodeSuccessmsg").hide();
                    HideMsg("#RenewalPromocodeErrMsg");
                } else {
                    if (!data.isvalid) {
                        $("#RenewalPromocodeErrMsg").show();
                        $("#RenewalPromocodeErrMsg").css('opacity', '');
                        $("#RenewalPromocodeSuccessmsg").css('opacity', '');
                        $("#RenewalPromocodeSuccessmsg").hide();
                        HideMsg("#RenewalPromocodeErrMsg");
                    } else {
                        $("#AdditionalPetRenewal").removeClass("input-validation-error");
                        $("#RenewalPromocodeErrMsg").hide();
                        $("#RenewalPromocodeSuccessmsg").css('opacity', '');
                        $("#RenewalPromocodeSuccessmsg").show();
                        HideMsg("#RenewalPromocodeSuccessmsg");
                    }
                    $.each(data.Items, function (index, item) {
                        subItems += "<option value='" + item.Value + "'>" + item.Text + "</option>";
                    });

                    $("#PlanName").html(subItems);
                    $('#RenuewalPlan').text(data.BasePlanDetails.FinalPlanName);
                    $("#RenewalPrice").text($("meta[name='accept-currency']").attr("content") + data.Price);
                    $("#AdditionalInfo").text(data.BasePlanDetails.AdditionInfo);

                    $("#AdditionalPets").removeAttr('readonly');
                    $("#AdditionalPets").removeAttr('disabled');

                    $("#MaxPetCount").val(data.MaxPetCount);
                    CalculatePrice();
                }
            });
}

function CalculatePrice(isFreeUser) {
    var isPromo = $("#IdPromo").val();
    var select1 = $("#MaxPetCount").val();
    var selectmultiple = 1, drpValue = 0;
    // alert($("#MaxPetCount").val());

    $('#AdditionalPetRenewal').children('option:not(:first)').remove();

    for (i = 0; finalval > drpValue; i++) {
        try {
            var o = document.createElement("option");
            o.value = selectmultiple;
            o.text = select1 * selectmultiple;
            drpValue = select1 * selectmultiple;
            if (!isPromo) {
                if (select1 >= (select1 * selectmultiple)) {
                    selectmultiple = selectmultiple + 1;
                    document.getElementById("AdditionalPetRenewal").appendChild(o);
                }
            }
            else {
                selectmultiple = selectmultiple + 1;
                document.getElementById("AdditionalPetRenewal").appendChild(o);
            }
        } catch (e) {
            break;
        }
    }

}

function HideMsg(id) {
    window.setTimeout(function () {
        $(id).fadeTo(1000, 0).slideUp(1000, function () {
            $(this).hide();
        });
    }, 2000);
}

function CloseDialogRemovePets() {
    $('.modal').modal('hide');
    getRenwalPetsPrice();
}
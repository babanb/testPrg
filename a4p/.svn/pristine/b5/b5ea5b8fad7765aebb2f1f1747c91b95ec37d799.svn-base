@model ADOPets.Web.ViewModels.Econsultation.DocumentUpload
@using Resources = ADOPets.Web.Resources.Wording;
@using ADOPets.Web.Common.Extensions
@using System.Web.UI.WebControls;
@using ADOPets.Web.Common.Helpers
@using Model


    @if( Model.Diagnosis != null)
    { 
        Model.FlagSave = 1;
    }
    else
    {
        Model.FlagSave = 0;    
    }

@Html.Hidden("PreviewURL", Url.Action("saveTempData", "Econsultation"))

@using (Html.BeginForm("SaveSubmitReport", "Econsultation", FormMethod.Post, new { enctype = "multipart/form-data", id = "frmID" }))
{
    @Html.HiddenFor(i => i.FilesToBeUploaded)
    @Html.HiddenFor(model => model.EcId)
    @Html.HiddenFor(model => model.PetId)
    @Html.HiddenFor(model => model.SaveClick, new { @name= "SaveClick", @id="SaveClick" })
    @Html.HiddenFor(model => model.Id)
    <div class="panel panel-primary">
        <div class="panel-body text-primary" style="font-weight:600;">
        @Resources.Econsultation_SubmitReport_StartTime - @Model.ActionBeginDate.Value.ToLongTimeString() <span style="padding:0 20px;">
        @Resources.Econsultation_SubmitReport_EndTime - @Model.ActionEndDate.Value.ToLongTimeString()</span> 
        @Resources.Econsultation_SubmitReport_Duration - @Model.Durations (Minutes) 
        <span style="padding:0 20px;">@Resources.Econsultation_SubmitReport_ECDate - @Model.ActionEndDate.Value.ToShortDateString()</span>
        </div>
    </div>
    
    <div class="form-group">
     <label for="lblDiagnosis">@Resources.Econsultation_SubmitReport_Diagnosis:</label>
     @Html.TextAreaFor(modelItem => Model.Diagnosis, new { @class = "form-control", @rows = "3", @placeholder = Resources.Econsultation_SubmitReport_DiagnosisPlaceHolder })
     @Html.ValidationMessageFor(modelItem => modelItem.Diagnosis)
        <br />
    <label for="lblDiagnosis">@Resources.Econsultation_SubmitReport_Treatment:</label>
     @Html.TextAreaFor(modelItem => Model.Treatment, new { @class = "form-control", @rows = "3", @placeholder = Resources.Econsultation_SubmitReport_TreatmentPlaceHolder })
     @Html.ValidationMessageFor(modelItem => modelItem.Treatment)    
    </div>
    
    <div class="row attachment2">
    <strong>@Resources.Econsultation_ViewReport_AttachedFile</strong> 

    <div id="uploaders">
        <div class="col-md-1">          
           <a href="#" onclick="" class="btn btn-success attachBtn" id="btnFileUpload">               
              <span class="fa fa-paperclip"></span>              
           </a>
           <input type="file" id="fileToUpload" name="fileUpload" multiple="multiple" style="display:none"/>
             
        </div>
        <div class="col-md-11">        
            @if (Model.lstAttachment != null)
                    {
                        foreach (var item in Model.lstAttachment)
                        {                        
                        <div class="btn-group" data-fileid="@item.Id">
                            <a href="@Url.Action("GetFile", "Econsultation", new { fileName = item.DocumentPath })" id="@("viewDocument" + ViewBag.DocumentType)"  
                            class="btn btn-default" target="_blank">@Html.CreateDivFromFileExtension(item.DocumentPath) @item.DocumentName</a>
                            <button type="button" class="btn btn-default" onclick="removeFile('@item.Id','@item.ECId')" ><span class="fa fa-times"></span></button>
                        </div>
                        }
                    }                    
        <div id="selectedFiles"></div>        
        </div>
        <span id="spnFile" style="float: left; color: #FF0000"></span>
        @Html.ValidationMessage("File")
        @Html.Hidden("hdnFileUpload")
    </div>
    </div>    
    <hr>
       <div class="form-group">
       <div class="col-md-6">
          <button type="button" id="btnSaveEC" onclick="SetSaveClick();" class="btn btn-info btn-lg pull-right" style="margin-left:4px;">@Resources.Econsultation_SubmitReport_Save</button>
          <a href="#" class="btn btn-primary btn-lg pull-right" onclick="toggle_visibility1();"><i class="fa fa-arrow-left"></i>@Resources.Econsultation_SubmitReport_Back</a>
          </div>
          <div class="col-md-6">
            <div id="previewECModel">
            <a id="previewEC" href="@Url.Action("PreviewEC", "Econsultation", new { Ecid = Model.EcId })",  data-href="@Url.Action("PreviewEC", "Econsultation", new { Ecid = Model.EcId })" class="btn btn-warning btn-lg pull-right" style="margin-left:10px">
                <i class="fa fa-eye"></i>@Resources.Econsultation_SubmitReport_ECPreView</a>
            </div>    
            <input type="hidden" id="hdnPetInfoStatus" name="hdnPetInfoStatus" />
              <input type="hidden" id="StatusSave" name="StatusSave" value="@Model.FlagSave" />
            <button class="btn btn-success btn-lg" id="btnAddIssue" type="submit">@Resources.Econsultation_SubmitReport_Submit</button>          
          </div>
        </div>
        <div class="clearfix"></div>         
 
}

<style type="text/css">
    #selectedFiles img
    {
        max-width: 200px;
        max-height: 200px;
        float: left;
        margin-bottom: 10px;
    }

    input[type='file']
    {
        color: transparent;
    }
</style>

<script src="@Url.Content("~/Scripts/customs/views/Econsultation/SaveReport.js")"></script>

<script>
    var nowTemp = new Date();
    var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);
    var files;
    var storedFiles = [];
    var upc = 0;



    $(function () {

        $(":file").attr('title', '  ');
        var $loading = $('#loadingDiv').hide();

        $("input[id^='fileToUpload']").change(function (e) {
            doReCreate(e);
        });

        selDiv = $("#selectedFiles");
    });


    function doReCreate(e) {
        upc = upc + 1;
        handleFileSelect(e);

        $("input[id^='fileToUpload']").hide();

        $('<input>').attr({
            type: 'file',
            multiple: 'multiple',
            id: 'fileToUpload' + upc,
            class: 'fUpload',
            name: 'fileUpload',
            style: 'display:none',
            title: '  ',
            onchange: "doReCreate(event)"

        }).appendTo('#uploaders');
    }


    function handleFileSelect(e) {

        selDiv = document.querySelector("#selectedFiles");

        if (!e.target.files) return;

        files = e.target.files;

        for (var i = 0; i < files.length; i++) {
            var f = files[i];
            var FileExt = f.name.substr(f.name.lastIndexOf('.') + 1);
            if (!(FileExt && /^(jpg|png|jpeg|gif|bmp|pdf|doc|docx|txt)$/i.test(FileExt))) {
                alert('Error: invalid file extension');
                return false;
            }
            var extString = "word";
            if (FileExt == "doc" || FileExt == "docx") {
                var extString = "word";
            }
            if (FileExt == "pdf") {
                var extString = "pdf";
            }
            if (FileExt == "txt") {
                var extString = "text";
            }
            if (FileExt == "jpg" || FileExt == "png" || FileExt == "jpeg" || FileExt == "gif" || FileExt == "bmp") {
                var extString = "photo";
            }
            selDiv.innerHTML += "<div class='btn-group'><div class='btn btn-default'><i class='fa  fa-file-" + extString + "-o' id='tr-0-" + FileExt.replace(/ /g, '') + "'></i>" + f.name + "</div><a onclick='removeAtt(this)'><button type='button' class='btn btn-default'><span class='fa fa-times'></span></button> </a></div>";
            storedFiles.push(f.name);
        }
        $('#@Html.IdFor(i => i.FilesToBeUploaded)').val(storedFiles);
}

function removeAtt(t) {
    var serEle = $(t).parent().text().slice(0, -3);
    var index = storedFiles.indexOf(serEle);
    if (index !== -1) {
        storedFiles.splice(index, 1);
    }
    $(t).parent().remove();

    $('#@Html.IdFor(i => i.FilesToBeUploaded)').val(storedFiles);

}

$(document).ready(function () {
    $('#btnFileUpload').click(function (e) {
        e.preventDefault();
        $('input[type=file]').click();         
    });
});

</script>

@section featured {
    <section class="featured">
        <div class="content-wrapper">
            <hgroup class="title">
            </hgroup>
            <p>
            </p>
        </div>
    </section>
}

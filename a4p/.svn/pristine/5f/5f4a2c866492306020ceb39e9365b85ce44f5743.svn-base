@model IEnumerable<ADOPets.Web.ViewModels.Pet.IndexViewModel>
@using ADOPets.Web.Common.Extensions
@using Model
@using Resources = ADOPets.Web.Resources.Wording


@{
    ViewBag.Title = Resources.Pet_Index_Title;
}
<div id="dvHdnTotalRecords" style="display: none;">
    @Model.Count().ToString()
</div>

<div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">@Resources.CloseButton</span></button>
            <h4 class="modal-title text-primary" id="myModalLabel">@Resources.Pet_Index_SelectYourPet</h4>
        </div>
        <div class="modal-body">
            <div class="well" id="vetsearch">
                <div class="row">
                    <div class="col-md-3">
                        <h4>@Resources.Pet_Index_SearchPet</h4>
                    </div>
                    <div class="col-md-4">
                        @Html.EnumDropDownList(typeof(PetTypeEnum), "SelectPetTypeFilter", ViewBag.PetType as PetTypeEnum?, Resources.Pet_Index_AnimalTypeOptionalLabel, new { @class = "form-control" })
                    </div>
                    <div class="col-md-4">
                        <label class="sr-only" for="bypetname">@Resources.Pet_Index_SearchByPetName</label>
                        @Html.TextBox("SelectPetNameFilter", string.Empty, new { placeholder = Resources.Pet_Index_AnimalNamePlaceHolder, @class = "form-control usericon" })
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-primary "><i class="fa fa-search" style="padding-right: 0;"></i></button>
                    </div>
                </div>
            </div>
            <div class="customscroll"> <div id="subCntnt1"></div>
                @if (Model != null && Model.Count() > 0)
                {      
                    <div id="listing-main" data-container="paging_container" data-page-size="5">
                        @foreach (var item in Model)
                        {           
                            <div class="listing2" data-sub-container="sub_container">

                                <div class="listing2Icon">
                                    @if (string.IsNullOrEmpty(item.PetImage))
                                    { 
                                        <img src="@Url.Content("~/Content/images/animal-dimg.jpg")" alt="" />
                                    }
                                    else
                                    {
                                        <img src="@Url.Action("Image", "Pet", new { fileName = item.PetImage, userInfoPath = item.OwnerInfoPath, ownerId = item.OwnerId })" alt="" />
                                    }
                                </div>
                                <div class="listing2content">
                                    <div class="row" data-item="item">
                                        <div class="col-md-5">
                                            <p>
                                                <strong>@Resources.Pet_Index_AnimalName</strong> : <span id="spnName" data-item-name="pet_name">@Html.DisplayFor(modelItem => item.PetName)</span><br>
                                                <strong>@Resources.Pet_Index_AnimalDateOfBirth</strong> : <span>@Html.DisplayFor(modelItem => item.PetBirthDate)</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p>
                                                <strong>@Resources.Pet_Index_AnimalSex</strong> : <span>@Html.DisplayFor(modelItem => item.PetGender)</span><br>
                                                <strong>@Resources.Pet_Index_AnimalType</strong> : <span id="spnPetType" data-item-type="pet_type">@Html.EnumDisplayFor(modelItem => item.PetType)</span>
                                            </p>
                                        </div>
                                        <div class="col-md-1">
                                            <a href="#" class="btn btn-success btn-sm" id="@(item.Id)" onclick="callBtnClick('@(item.Id)')" data-myitemid="@(item.Id)" data-tooltip="tooltip" data-placement="left" title="" data-original-title="Select"><i id="selectPetAnchor" class="fa fa-square-o"></i></a>
                                        </div>
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        }

                    </div>
                    <div id="pagingControls" data-paging-control="paging_control"></div>
                }
                else
                {
@*<div class="row">
                        <h4 style="text-align: center; margin-top: 20px;" class="text-primary">
                            @Resources.Pet_Index_NoRecords<br>
                        </h4>
                    </div>*@
                }
            </div>
        </div>
        <div class="modal-footer">

            <button type="button" id="petclose-bt" class="btn btn-default" data-dismiss="modal">@Resources.Pet_Index_Close</button>
            <div class="clearfix"></div>
        </div>

    </div>
</div>
}

<script src="@Url.Content("~/Scripts/external/bootstrap-confirmation.js")"></script>
<script src="@Url.Content("~/Scripts/external/pagination.js")"></script>

<script>
    var resourceMessage = '@Html.Raw(Resources.Pet_Index_PagedListPagerPageItemSliceAndTotalFormat)';
    var pager = new Pager();

    $(document).ready(function () {
        initPager(true);
        deleteConfirmation();
    });

    function deleteConfirmation() {
        $('[data-toggle="confirmation"]').confirmation({
            title: '@Html.Raw(Resources.Pet_Index_StatusConfirmationTitle)',
            btnOkLabel: '@Html.Raw(Resources.Pet_Index_StatusConfirmationOkLabel)',
            btnCancelLabel: '@Html.Raw(Resources.Pet_Index_StatusConfirmationCancelLabel)'
        });
    }

    /*****************TODO :: For filter and search of Pets ********************/

    $('#SelectPetTypeFilter').change(function () {
        $("#dvNoRecords").remove();
        showAll();
        var sel = $(this).val();
        if (sel != "") {
            var filtertype = $("#SelectPetTypeFilter option:selected").text();// $('#SelectPetTypeFilter')[0][sel].label;
            displayRecordsSelectPet(filtertype, 'SelectPetNameFilter', 'listing2');
        }
        else {
            $('div[class="listing2"]').removeAttr('style');
            filtertype = $("#SelectPetNameFilter").val();
            if (filtertype == "" || filtertype == undefined) {
                showAll();
            } else {
                filtertype = filtertype.toLowerCase();
                displayRecordsSelectPetStartsWith(filtertype, 'SelectPetTypeFilter', 'listing2');
                showPageFilter();
            }
        }
    });

    $("#SelectPetNameFilter").on('keyup click', function () {
        filtertype = $("#SelectPetNameFilter").val();
        showAll();
        if (filtertype != "") {
            filtertype = filtertype.toLowerCase();
            displayRecordsSelectPetStartsWith(filtertype, 'SelectPetTypeFilter', 'listing2');
        }
        else {
            $("[data-sub-container='sub_container']").removeAttr('style');
            var filtertype = $('#SelectPetTypeFilter').val();
            if (filtertype == "") { showAll(); } else {
                var filterPetType = $("#SelectPetTypeFilter option:selected").text(); //$('#SelectPetTypeFilter')[0][filtertype].label;
                displayRecordsSelectPet(filterPetType, 'SelectPetNameFilter', 'listing2');
                showPageFilter();
            }
        }
    });

    function displayRecordsSelectPetStartsWith(filtertype, petTypeFilter, subClass) {
        var petType = $('#' + petTypeFilter).val();
        var filterPetType = "";

        if (petType != undefined && petType != "") {
            filterPetType = $("#" + petTypeFilter + " option:selected").text();// $('#' + petTypeFilter)[0][petType].label;
        }

        filterPetType = filterPetType.toLowerCase();

        if (filterPetType == undefined || filterPetType == "") {
            if ($('div[class="' + subClass + '"] :visible').find("[data-item-name='pet_name']")) {
                var param = $('.' + subClass + ' :visible');
                $.each(param.find("[data-item-name='pet_name']"), function (key, val) {
                    if (val.innerHTML.toLowerCase().match("^" + filtertype)) {
                        $(this).parent().parent().parent().parent().parent().show();
                    }
                    else {
                        $(this).parent().parent().parent().parent().parent().hide();
                    }
                });
            }
        } else {

            if ($('div[class="' + subClass + '"] :visible').find("[data-item-name='pet_name']")) {
                var param = $('.' + subClass + ' :visible');
                $.each(param.find("[data-item-name='pet_name']"), function (key, val) {
                    if (val.innerHTML.toLowerCase().match("^" + filtertype)) {
                        $.each($(this).parent().parent().parent().parent().find("[data-item-type='pet_type']"), function (key, val) {
                            if (filterPetType == val.innerHTML.toLowerCase().trim()) {
                                $(this).parent().parent().parent().parent().parent().show();
                            } else {
                                $(this).parent().parent().parent().parent().parent().hide();
                            }
                        });
                    }
                    else {
                        $(this).parent().parent().parent().parent().parent().hide();
                    }
                });
            }
        }
        displayResultSelectPet();
    }

    function displayRecordsSelectPet(filtertype, petNameFilter, subClass) {
        filterText = $("#" + petNameFilter).val();
        filterText = filterText.toLowerCase();
        filtertype = filtertype.toLowerCase();

        if (filterText == undefined || filterText == "") {
            if ($('div[class="' + subClass + '"] :visible').find("[data-item-type='pet_type']")) {
                var param = $('.' + subClass + ' :visible');
                $.each(param.find("[data-item-type='pet_type']"), function (key, val) {
                    if (filtertype == val.innerHTML.toLowerCase().trim()) {
                        $(this).parent().parent().parent().parent().parent().show();
                    }
                    else {
                        $(this).parent().parent().parent().parent().parent().hide();
                    }
                });
            }
        }
        else {
            if ($('div[class="' + subClass + '"] :visible').find("[data-item-type='pet_type']")) {
                var param = $('.' + subClass + ' :visible');
                $.each(param.find("[data-item-type='pet_type']"), function (key, val) {
                    if (filtertype == val.innerHTML.toLowerCase().trim()) {
                        $.each($(this).parent().parent().parent().parent().find("[data-item-name='pet_name']"), function (key, val) {
                            if (val.innerHTML.toLowerCase().match("^" + filterText)) {
                                $(this).parent().parent().parent().parent().parent().show();
                            } else {
                                $(this).parent().parent().parent().parent().parent().hide();
                            }
                        });
                    }
                    else {
                        $(this).parent().parent().parent().parent().parent().hide();
                    }
                });
            }
        }
        displayResultSelectPet();
    }

    function displayResultSelectPet() {
        $("[data-paging-control='paging_control']").show();
        var itemCount = $('div.listing2').find("#spnPetType").length;
        var chkcount = 0;
        $.each($('div.listing2'), function (key, val) {
            if ($(this).css('display') == 'none') {
                chkcount = chkcount + 1;
            }
        });
        if (chkcount == itemCount) {
            showPageFilter();
            //$('div[data-container="paging_container"]').append("<div class='petlist'><div class='row'><div id='dvNoRecords'>" + '@Html.Raw(Resources.Pet_Index_FilterNoResult)' + "</div</div</div>");
            //$(".petlist").slideDown(500);
        }
        else {
            $("#dvNoRecords").remove();
            $("[data-paging-control='paging_control']").show('slow');
            showPageFilter();
        }

        if (totalRecordsOnPage == 0) {
            $('div[data-container="paging_container"]').append("<div class='petlist'><div class='row'><div id='dvNoRecords'>" + '@Html.Raw(Resources.Pet_Index_FilterNoResult)' + "</div</div</div>");
            $(".petlist").slideDown(500);
        }
    }

    function callBtnClick(id) {
        var oItemId = id;
        var doctitle = $("#" + id).find("i[id*=selectPetAnchor]");
        var doc = $('.fa-check-square');
        $.ajax({
            url: '@Url.Action("SelectPet", "SMO")',
            data: { Id: oItemId },
            type: 'POST',
            dataType: 'json',
            success: function (success) {
                if (success.success == true) {
                    doc.removeClass("fa-check-square").addClass("fa-square-o");
                    doctitle.removeClass("fa-square-o").addClass("fa-check-square");
                    $('#petclose-bt').click();
                    $("#selectPet").text(success.data.Value);
                    localStorage['selectedPet'] = $('#selectPet').text();
                    $("#selectPet").removeAttr('style');
                    $("#spnPetRequired").remove();
                }
                else if (success.success == false) {
                    $('#petclose-bt').click();
                    $("#selectPet").html("<i class='fa fa-check-square'></i>Click here");
                    ShowAjaxWarningMessage("A second medical opinion is already in progress for this pet. Please select another pet.");

                }
            },
            error: function (req, status, error) {

            }
        });
    }
</script>

$(document).ready(function () {
    $("#AdditionalPetRenewal option").filter(function (index) { return $(this).val() === '0'; }).html($('#changeselectText').val()).val(0);
    var selectedItem = parseInt($('#CurrentPlan_NumberofPets').val());
    $('#AdditionalPetRenewal').val(selectedItem);
    GetPlanDetails();

    $('#CancelRenewalPlan').click(function () {
        $('#RenewaltMyPlan').removeClass('tab-pane fade in active').addClass('tab-pane fade');
        $('#MyPlan').removeClass('tab-pane fade').addClass('tab-pane fade in active');
        localStorage.clear();

        $.getJSON(GetApplicationPath() + "Profile/ClearSessionData",
            function (data) {
                console.log(data);
            });

        $("#dvDeletedItem").val('');
        $("#DeletedUnUsedPets").val('');
        $('#CurrentPlan_NumberofPets').val($('#PlanDetails_numberofPets').val());
        $('#AdditionalPetRenewal').val($('#PlanDetails_numberofPets').val());
      //  getRenwalPetsPrice();
    });


    $("#PlanName").change(function () {
        GetPlanDetails();
    });

    $("#AdditionalPetRenewal").change(function () {
        getRenwalPetsPrice();

    });

    $('#PlansByPromoCode').click(function () {
        ChangePlanListByPromoCode();
    });


    $('#RemovePets').click(function (e) {

        e.preventDefault();
        $.get(this.href, function (data) {
            $('#DeletepetsModel').html(data);

            Initialize();

            //$.validator.unobtrusive.parse("#addPulseForm");

            $('#DeletepetsModel').modal('show');



        });

    });



});


function getRenwalPetsPrice() {
    var AdditionalPets = $('#AdditionalPetRenewal :selected').val();
    AdditionalPets = AdditionalPets || 0;
    var selectedItem = parseInt($('#CurrentPlan_NumberofPets').val());
    selectedItem = selectedItem || 0;
    if (AdditionalPets < selectedItem) {
        $("#AdditionalPetRenewal").addClass("input-validation-error");
        $("#AddPetsRenewalErrMsg").show();
        GetPrice(selectedItem);
    } else {
        $("#AddPetsRenewalErrMsg").hide();
        $("#AdditionalPetRenewal").removeClass("input-validation-error");
        GetPrice(AdditionalPets);
    }
}
function GetPrice(AdditionalPets) {

    var Planid = $('#PlanName :selected').val();
    $.getJSON(GetApplicationPath() + "Profile/GetPlanPrice", { PlanID: Planid, AdditionalPets: AdditionalPets },
    function (data) {
        $('#RenuewalPlan').text(data.finalPlan);
        $('#RenewalPrice').text($("meta[name='accept-currency']").attr("content") + data.price);
        $("#AdditionalInfo").text(data.AdditionalInfo);
    });

}




function GetPlanDetails() {
    var renewalDate;
    var culture = GetCurrentCulture();
    var Planid = $('#PlanName :selected').val();
    var remainingDays = parseInt($('#RemainingDays').val(), 10);
    if (remainingDays > 0) {
        var d = new Date($('#lblExpirationDate').text());
        if (culture == "en-US") {
            renewalDate = (d.getMonth() + 1) + "/" + (d.getDate() + 1) + "/" + d.getFullYear();
        } else {
            renewalDate = (d.getDate() + 1) + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
        }
    } else {
        var d = new Date()
        if (culture == "en-US") {
            renewalDate = (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
        } else {
            renewalDate = d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
        }
    }

    $.getJSON(GetApplicationPath() + "Profile/GetStartDate", { PlanID: Planid, RenewalDate: renewalDate },
    function (data) {
        var expDate;
        var startdate;

        // get expdate
        var dateString = data.ExpirationDate.substr(6);
        var d = new Date(parseInt(dateString));
        if (culture == "en-US") {
            expDate = (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
        } else {
            expDate = d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();
        }

        //get startDate
        var dateString2 = data.StartDate.substr(6);
        var sd = new Date(parseInt(dateString2));
        if (culture == "en-US") {
            startdate = (sd.getMonth() + 1) + "/" + sd.getDate() + "/" + sd.getFullYear();
        } else {
            startdate = sd.getDate() + "/" + (sd.getMonth() + 1) + "/" + sd.getFullYear();
        }

        $('#lblStartDate').text(startdate);
        $('#StartDate').val(startdate);
        $('#lblExpirationDate').text(expDate);
        $('#EndDate').val(expDate);
        $('#Duration').text(data.Dueration);
        $('#TotalRemainigDays').text(data.RemainingDyas);
        $('#lblFinalplanName').text(data.price);
    });

}

function ChangePlanListByPromoCode() {
    var promocode = $('#IdPromo').val();
    var CurrentPromo = $('#Promocode').val();
    var AdditionalPets = $('#AdditionalPetRenewal :selected').val();
    var subItems;
    $.getJSON(GetApplicationPath() + "Profile/GetPlansByPromocode", { promocode: promocode, AdditionalPets: AdditionalPets, CurrentPromo: CurrentPromo },
            function (data) {
                if (data.length == 0) {
                    $("#AdditionalPetRenewal").addClass("input-validation-error");
                    $("#RenewalPromocodeErrMsg").css('opacity', '');
                    $("#RenewalPromocodeErrMsg").show();
                    $("#RenewalPromocodeSuccessmsg").hide();
                    HideMsg("#RenewalPromocodeErrMsg");
                } else {
                    if (!data.isvalid) {
                        $("#RenewalPromocodeErrMsg").show();
                        $("#RenewalPromocodeErrMsg").css('opacity', '');
                        $("#RenewalPromocodeSuccessmsg").css('opacity', '');
                        $("#RenewalPromocodeSuccessmsg").hide();
                        HideMsg("#RenewalPromocodeErrMsg");
                    } else {
                        $("#AdditionalPetRenewal").removeClass("input-validation-error");
                        $("#RenewalPromocodeErrMsg").hide();
                        $("#RenewalPromocodeSuccessmsg").css('opacity', '');
                        $("#RenewalPromocodeSuccessmsg").show();
                        HideMsg("#RenewalPromocodeSuccessmsg");
                    }
                    $.each(data.Items, function (index, item) {
                        subItems += "<option value='" + item.Value + "'>" + item.Text + "</option>";
                    });

                    $("#PlanName").html(subItems);
                    $('#RenuewalPlan').text(data.BasePlanDetails.FinalPlanName);
                    $("#RenewalPrice").text($("meta[name='accept-currency']").attr("content") + data.Price);
                    $("#AdditionalInfo").text(data.BasePlanDetails.AdditionInfo);

                }
            });
}


function HideMsg(id) {
    window.setTimeout(function () {
        $(id).fadeTo(1000, 0).slideUp(1000, function () {
            $(this).hide();
        });
    }, 2000);
}

function CloseDialogRemovePets() {
    $('.modal').modal('hide');
    getRenwalPetsPrice();
}